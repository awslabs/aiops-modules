publishGenericEnvVariables: true
deploy:
  phases:
    install:
      commands:
        # Install terraform
        - TERRAFORM_VERSION=1.12.2
        - wget https://releases.hashicorp.com/terraform/"$TERRAFORM_VERSION"/terraform_"$TERRAFORM_VERSION"_linux_amd64.zip
        - unzip terraform_"$TERRAFORM_VERSION"_linux_amd64.zip
        - mv terraform /usr/local/bin/
        # Install helm
        - curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
        # Download helm charts
        - ./scripts/get_helm_charts.sh
    build:
      commands:
      - terraform init -backend-config="bucket=${SEEDFARMER_PARAMETER_TFSTATE_BUCKET_NAME}" -backend-config="region=${AWS_REGION}"
      - echo "resource_name_prefix  = \"${SEEDFARMER_PARAMETER_RESOURCE_NAME_PREFIX:-${SEEDFARMER_PROJECT_NAME}-${SEEDFARMER_DEPLOYMENT_NAME}-${SEEDFARMER_MODULE_NAME}\"" >> custom.tfvars
      - echo "eks_cluster_name  = \"${SEEDFARMER_PARAMETER_EKS_CLUSTER_NAME:-${SEEDFARMER_PROJECT_NAME}-${SEEDFARMER_DEPLOYMENT_NAME}-${SEEDFARMER_MODULE_NAME}-eks-cluster}\"" >> custom.tfvars
      - echo "hyperpod_cluster_name  = \"${SEEDFARMER_PARAMETER_HYPERPOD_CLUSTER_NAME:-${SEEDFARMER_PROJECT_NAME}-${SEEDFARMER_DEPLOYMENT_NAME}-${SEEDFARMER_MODULE_NAME}-hyperpod-cluster}\"" >> custom.tfvars
      - |
        if [ -n "$SEEDFARMER_PARAMETER_TRAINING_PLAN_ARN" ] ; then
          sed -i "s|training_plan_arn = .*|training_plan_arn = \"$SEEDFARMER_PARAMETER_TRAINING_PLAN_ARN\"|" custom.tfvars
        fi
      - |
        if [ -n "$SEEDFARMER_PARAMETER_INSTANCE_GROUPS" ] ; then
          # Remove existing instance_groups block and add new one
          sed -i '/^instance_groups = {/,/^}/d' custom.tfvars
          echo "instance_groups = $SEEDFARMER_PARAMETER_INSTANCE_GROUPS" >> custom.tfvars
        fi
      - echo "availability_zone_id  = \"${SEEDFARMER_PARAMETER_AVAILABILITY_ZONE_ID}\"" >> custom.tfvars
      - terraform plan -var-file=custom.tfvars -out tf.plan -replace='helm_release.hyperpod[0]'
      - terraform apply -replace='helm_release.hyperpod[0]' tf.plan
      # Fetch terraform outputs
      - ./scripts/terraform_outputs.sh
      - cat terraform_outputs.json
    post_build:
      commands:
      - echo "Deploy successful"
destroy:
  phases:
    install:
      commands:
        # Install terraform
        - TERRAFORM_VERSION=1.12.2
        - wget https://releases.hashicorp.com/terraform/"$TERRAFORM_VERSION"/terraform_"$TERRAFORM_VERSION"_linux_amd64.zip
        - unzip terraform_"$TERRAFORM_VERSION"_linux_amd64.zip
        - mv terraform /usr/local/bin/
        # Install helm
        - curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
        # Download helm charts
        - ./scripts/get_helm_charts.sh
    build:
      commands:
       - terraform init -backend-config="bucket=${SEEDFARMER_PARAMETER_TFSTATE_BUCKET_NAME}" -backend-config="region=${AWS_REGION}"
       - terraform plan -destroy -var-file=custom.tfvars -out tf_destroy.plan
       - terraform apply tf_destroy.plan
    post_build:
      commands:
      - echo "Destroy successful"
build_type: BUILD_GENERAL1_SMALL